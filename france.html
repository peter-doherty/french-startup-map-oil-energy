<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>French Startup Map | Oil &amp; Energy | Peter Doherty Copyright 2018</title>
</head>

<style>
    .title {
        font-weight: 500;
        text-transform: uppercase;
        text-anchor: middle;
        opacity: 0.25;
        color: #000;
        font-family: 'Trebuchet MS', sans-serif;
        font-size: 10px;
        line-height: 28px;
        letter-spacing: 0.33em;
    }

    .place-label {
        font-size: 1px;
        fill: rgb(27, 27, 27);
        font-style: italic;
        font-family: 'Tahoma';
    }

    .startup-label {
        font-size: 0.5px;
        fill: #444;
        font-family: 'Open Sans';
    }

</style>

<body>
    <svg width="1280" height="600"></svg>
    <script src="http://d3js.org/d3.v4.min.js"></script>
    <script>
        // Hubs = Paris, Brest etc
        // Transit Lines connect hubs
        // Spawning from the hubs are lines which startups are located on

        var svg = d3.select("svg"),
            margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = innerWidth - margin.left - margin.right,
            height = innerHeight - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // spacing for label text
        var spaceX = 1.005;

        var scale = 2800;

        var projection = d3.geoConicConformal()
            .center([2.454071, 46.279229])
            .scale(scale)
            .translate([width / 2, height / 2]);

        var path = d3.geoPath()
            .projection(projection);
        
        //create zoom handler 
        //zoom actions is a function that performs the zooming. 
        var zoom_handler = d3.zoom()
            .on("zoom", zoom_actions);

        // France Data
        d3.json("map_data/lines+border.geojson", function(err, mapData) {
            if (err) throw error;

            var features = mapData.features;
            console.log(features);

            // Draw border and lines
            g.selectAll("path")
                .data(features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", "#ddc")
                .attr("stroke", function (d) { return d.properties.stroke; })
                .attr("stroke-width", function (d) { return +d.properties["stroke-width"]; })
                .style("vector-effect", "non-scaling-stroke");

            // //Load in startups and cities from CSV data
            d3.csv("map_data/master.csv", function(err, data) {
                if (err) throw error;
                
                g.selectAll("circle")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx", function(d) { return projection([d.lon, d.lat])[0]; })
                    .attr("cy", function(d) { return projection([d.lon, d.lat])[1]; })
                    .attr("r", function(d) { return d.r * 0.25; })
                    .attr("class", "tooltip")
                    .style("fill", function(d) { return d["marker-color"]; });
                
                // City or region Title
                g.selectAll(".place-label")
                    .data(data)
                    .enter()
                    .append("text")
                    .attr("class", "place-label")
                    .attr("transform", function(d) { return "translate(" + projection([d.lon * spaceX, d.lat]) + ")"; })
                    .style("text-anchor", function(d) { return d.lon > -0.5 ? "start" : "end"; }) // west -> assign labels on LHS; east -> assign labels on RHS
                    .attr("dy", ".35em")
                    .text(function(d) { return d.name; });
                
                // Startup Title
                g.selectAll(".startup-label")
                    .data(data)
                    .enter()
                    .append("text")
                    .attr("class", "startup-label")
                    .attr("transform", function(d) { return "translate(" + projection([d.lon * spaceX, d.lat]) + ")"; })
                    .style("text-anchor", function(d) { return d.lon > -1 ? "start" : "end"; })
                    .attr("dy", ".35em")
                    .text(function(d) { return d.id; });

            });

            // Map Title
            g.append("text")
                .attr("class", "title")
                .attr("x", width * 0.5)
                .attr("y", height * 0.4)
                .text('French Startup Map | Oil & Energy');

        });
        // Zoom http://www.puzzlr.org/zoom-in-d3v4-minimal-example/
        //specify what to do when zoom event listener is triggered 
        function zoom_actions(){
            g.attr("transform", d3.event.transform);
            
            g.selectAll("circle") 
                .attr("r", function(d) { return d.r * 0.015; }); // redraw circles upon zoom in

        }

        //add zoom behaviour to the svg element 
        //same as svg.call(zoom_handler); 
        zoom_handler(svg);
    </script>

</body>
</html>